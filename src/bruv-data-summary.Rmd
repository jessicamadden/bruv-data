---
title: "BRUV data summary 2019"
author: "Jessica Madden"
date: "November 30, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(here)
library(tidyverse)
library(kableExtra)
library(janitor)
library(data.table)
library(knitr)

# Load in data
max_n_data <- read.csv(here("data", "max_n_data.csv")) %>% 
  clean_names()
```


```{r}
# Count number of distinct species

species_total <- max_n_data %>% 
  filter(subclass == "Actinopterygii" | subclass == "Elasmobranchii") %>% 
  pull(sp_code) %>% 
  n_distinct()

# Count number of distinct families

families_total <- max_n_data %>% 
  filter(subclass == "Actinopterygii" | subclass == "Elasmobranchii") %>% 
  pull(family_x) %>% 
  n_distinct()
```


A total of `r species_total` species belonging to `r families_total` families were recorded from BRUV deployments at all of the locations combined, and of these approximately  were present at three or more locations. 

### % Presence

```{r}
# Calculate number of deployments in which each species is present for each site

presence <- max_n_data %>% 
  filter(subclass == "Actinopterygii" | subclass == "Elasmobranchii") %>% 
  group_by(site_full) %>% 
  count(sp_code, common) %>% 
  rename("count" = "n")
  
#Calculate number of deployments for each site from max_n_data data frame

number_deployments <- max_n_data %>% 
  group_by(site_full) %>% 
  summarize(deployments = n_distinct(op_code))

# Join data frames and calc % presence for each species site combination

presence_table <- presence %>% 
  full_join(number_deployments, by = "site_full") %>% 
  mutate(deployments = as.numeric(deployments)) %>% 
  mutate(perc_presence = (count / deployments)*100)

# Obtain Max % presence for each species

max_presence_table <- presence_table %>% 
  group_by(common) %>% 
  summarize(max_presence = max(perc_presence))
```

Table 1. Max % presence 
```{r}
max_presence_table %>% 
  kbl() %>% 
  kable_styling()
```

### Species Richness

```{r}
sp_richness <- max_n_data %>% 
 filter(subclass == "Actinopterygii" | subclass == "Elasmobranchii") %>% 
  group_by(site_full, geog, type) %>% 
  summarise(n_distinct(common)) %>% 
  rename("sp_richness" = "n_distinct(common)") %>% 
  arrange(geog)

```

***Table 1.** Species richness at each site. Species richness represents number of unique species (Actinopterygii, Elasmobranchii) observed in all BRUV videos at each site (n = 9).*
```{r}
richness_table <- sp_richness %>% 
  rename("Species richness" = "sp_richness") %>% 
  rename("Type" = "type") %>% 
  rename("Site" = "site_full") %>% 
  subset(select=-geog) %>% 
  kbl() %>% 
  kable_styling()
richness_table
```

```{r}
ggplot(sp_richness, aes(x = reorder(site_full, -geog), y = sp_richness)) +
  geom_bar(stat="identity", 
           aes(fill = type)) +
  coord_flip() +
  labs(x = "Site", y = "Species richness") +
  theme_minimal()
```

***Figure 1.** Species richness at each site. Species richness represents number of unique species (Actinopterygii, Elasmobranchii) observed in all BRUV videos at each site (n = 9).*

### Max N 

#### Max N by species



```{r}
maxN_table <- max_n_data %>% 
  filter(subclass == "Actinopterygii" | subclass == "Elasmobranchii") %>% 
  group_by(site_full, geog, common, family_x) %>% 
  summarise(maxN = max(max_n))

# Transpose site data into columns

maxN_wider <- maxN_table %>% 
  pivot_wider(id_cols = c(common, family_x), 
              names_from = site_full, 
              values_from = maxN) %>% 
  arrange(family_x) %>% 
    full_join(max_presence_table, by = "common") %>% 
  relocate(max_presence, .after = family_x) %>% 
  rename("Common name" = "common", "Family" = "family_x", "Max % presence" = "max_presence")


# Change NAs to zeroes

#maxN_wider[is.na(maxN_wider)] = 0
```

***Table 2.** Max N statistic for each species at 10 sampling locations. Number represents the maximum number of individuals belonging to each species counted in a single frame, across all sampling videos at each site (n = 9).* 
```{r}
opts <- options(knitr.kable.NA = "")

maxN_wider %>% 
  kable(digits = 0) %>% 
  kable_styling()
```



```{r}
ggplot(maxN_table, aes(fill = common, x = reorder(site_full, -geog), y = maxN)) +
  geom_bar(position = "stack", stat = "identity") +
  coord_flip() +
  labs(x = "Site", y = "Max N") +
  theme_minimal() +
  theme(legend.position = "top")

ggplot(maxN_table, aes(fill = common, x = reorder(site_full, -geog), y = maxN)) +
  geom_bar(position = "fill", stat = "identity") +
  coord_flip() +
  labs(x = "Site", y = "% Max N") +
  theme_minimal()
```

***Figure 2. ** Max N statistic for each species at each site.*

#### Max N by family

```{r}
# Make table of maxN aggregated by family

maxN_fam_table <- max_n_data %>% 
  filter(subclass == "Actinopterygii" | subclass == "Elasmobranchii") %>% 
  group_by(site_full, geog, common, family_x) %>% 
  summarise(sp_maxN = max(max_n)) %>%
  group_by(site_full, geog, family_x) %>% 
  summarise(fam_maxN = sum(sp_maxN))
  

ggplot(maxN_fam_table, aes(fill = family_x, x = reorder(site_full, -geog), y = fam_maxN)) +
  geom_bar(position = "stack", stat = "identity") +
  coord_flip() +
  labs(x = "Site", y = "Max N") +
  theme_minimal() +
  theme(legend.position = "top")

ggplot(maxN_fam_table, aes(fill = site_full, x = family_x, y = fam_maxN)) +
  geom_bar(position = "dodge", stat = "identity") +
  labs(x = "Site", y = "Max N") +
  coord_flip() +
  theme_minimal() 
```

***Figure 3. ** Max N statistic for each family at each site.*
