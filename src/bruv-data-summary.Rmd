---
title: "BRUV data summary 2019"
author: "Jessica Madden"
date: "November 30, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(here)
library(tidyverse)
library(kableExtra)
library(janitor)
library(data.table)
library(knitr)

# Load in data
max_n_data <- read.csv(here("data", "max_n_data.csv")) %>% 
  clean_names()
```

### Initial wrangling

```{r}
max_n_data <- max_n_data %>% 
    mutate(geog = case_when(
    site_code == "WABE" ~ 1, 
    site_code == "PISM" ~ 2, 
    site_code == "PERC" ~ 3, 
    site_code == "REFU" ~ 4, 
    site_code == "SOCA" ~ 5, 
    site_code == "HABE" ~ 6, 
    site_code == "DUCO" ~ 7, 
    site_code == "LECA" ~ 8, 
    site_code == "SLHO" ~ 9, 
    site_code == "STBE" ~ 10, 
    site_code == "SCRI" ~ 11, 
    site_code == "SAEL" ~ 12
  )) %>% #added geographic sorting column
  mutate(type = case_when(
    mpa == "1" ~ "MPA", 
    mpa == "0" ~ "Reference"
  )) %>%  #adds columns for mpa/reference
  arrange(geog, date, bruv)


```

### % Presence

```{r}
presence_table <- max_n_data %>% 
  filter(subclass == "Actinopterygii" | subclass == "Elasmobranchii") %>% 
  group_by(site_full, date) %>% 
  count(sp_code, common)
  
```


### Species Richness

```{r}
sp_richness <- max_n_data %>% 
 filter(subclass == "Actinopterygii" | subclass == "Elasmobranchii") %>% 
  group_by(site_full, geog, type) %>% 
  summarise(n_distinct(common)) %>% 
  rename("sp_richness" = "n_distinct(common)") %>% 
  arrange(geog)

```

***Table 1.** Species richness at each site. Species richness represents number of unique species (Actinopterygii, Elasmobranchii) observed in all BRUV videos at each site (n = 9).*
```{r}
richness_table <- sp_richness %>% 
  rename("Species richness" = "sp_richness") %>% 
  rename("Type" = "type") %>% 
  rename("Site" = "site_full") %>% 
  subset(select=-geog) %>% 
  kbl() %>% 
  kable_styling()
richness_table
```

```{r}
ggplot(sp_richness, aes(x = reorder(site_full, -geog), y = sp_richness)) +
  geom_bar(stat="identity", 
           aes(fill = type)) +
  scale_fill_brewer(palette="Dark2") +
  coord_flip() +
  labs(x = "Site", y = "Species richness") +
  theme_minimal()
```

***Figure 1.** Species richness at each site. Species richness represents number of unique species (Actinopterygii, Elasmobranchii) observed in all BRUV videos at each site (n = 9).*

### Max N 

#### Max N by species



```{r}
maxN_table <- max_n_data %>% 
  filter(subclass == "Actinopterygii" | subclass == "Elasmobranchii") %>% 
  group_by(site_full, geog, common, family_x) %>% 
  summarise(maxN = max(max_n))

# Transpose site data into columns

maxN_wider <- maxN_table %>% 
  pivot_wider(id_cols = c(common, family_x), 
              names_from = site_full, 
              values_from = maxN) %>% 
  arrange(family_x) %>% 
  rename("Family" = "family_x", "Common name" = "common")

# Change NAs to zeroes

#maxN_wider[is.na(maxN_wider)] = 0
```

***Table 2.** Max N statistic for each species at 10 sampling locations. Number represents the maximum number of individuals belonging to each species counted in a single frame, across all sampling videos at each site (n = 9).* 
```{r}
opts <- options(knitr.kable.NA = "")
maxN_wider %>% 
  kbl() %>% 
  kable_styling()

```



```{r}
ggplot(maxN_table, aes(fill = common, x = reorder(site_full, -geog), y = maxN)) +
  geom_bar(position = "stack", stat = "identity") +
  coord_flip() +
  labs(x = "Site", y = "Max N") +
  theme_minimal() +
  theme(legend.position = "top")
```
***Figure 2. ** Max N statistic for each species at each site.*

#### Max N by family

```{r}
maxN_fam_table <- max_n_data %>% 
  filter(subclass == "Actinopterygii" | subclass == "Elasmobranchii") %>% 
  group_by(site_full, geog, family_x) %>% 
  summarise(maxN = max(max_n))

ggplot(maxN_fam_table, aes(fill = family_x, x = reorder(site_full, -geog), y = maxN)) +
  geom_bar(position = "stack", stat = "identity") +
  coord_flip() +
  labs(x = "Site", y = "Max N") +
  theme_minimal() +
  theme(legend.position = "top")

```
***Figure 3. ** Max N statistic for each family at each site.*
